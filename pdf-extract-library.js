const fs = require('fs');
const path = require('path');
const pdf = require('pdf-parse'); 

// --- Configuration for Pattern Matching ---
// Regex to find artifact IDs like "YYYY.NN.MM [Description]".
const ARTIFACT_ID_REGEX = /(\d{4}\.\d{1,3}\.\d{1,3}[a-z]?[-\w]*(?:\s[\w\s,]+)?)/g;

// --- Placeholder Data Generator (Mock Image) ---
const generatePlaceholderDataUrl = (text) => {
    const cleanText = text.replace(/"/g, '').trim();
    const parts = cleanText.split(/ /);
    const labelMain = parts[0]; 
    const labelSub = parts.slice(1).join(' ') || 'Artifact'; 

    const svgContent = `
        <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="200" fill="#f0f9ff"/>
            <rect x="10" y="10" width="180" height="180" fill="#a7d9eb" stroke="#00587d" stroke-width="2"/>
            <text x="100" y="50" font-family="Inter, sans-serif" font-size="16" fill="#00587d" text-anchor="middle" font-weight="bold">AUTOGENERATED LABEL</text>
            <text x="100" y="110" font-family="Inter, sans-serif" font-size="18" fill="#00587d" text-anchor="middle" font-weight="700">${labelMain}</text>
            <text x="100" y="140" font-family="Inter, sans-serif" font-size="12" fill="#00587d" text-anchor="middle" font-style="italic">${labelSub}</text>
        </svg>
    `;
    return `data:image/svg+xml;base64,${Buffer.from(svgContent).toString('base64')}`;
};

/**
 * Extracts artifact labels from the PDF text using the accession number pattern.
 */
async function extractImagesWithLabels(pdfFilePath) {
    if (!fs.existsSync(pdfFilePath)) {
        throw new Error(`File not found: ${pdfFilePath}.`);
    }

    const dataBuffer = fs.readFileSync(pdfFilePath);
    
    // Use pdf-parse to extract raw text content
    const data = await pdf(dataBuffer);
    const pdfText = data.text;
    
    let foundLabels = [];
    let match;

    // Use the Regex to find all matches of the artifact ID pattern
    while ((match = ARTIFACT_ID_REGEX.exec(pdfText)) !== null) {
        const label = match[0].trim();
        
        // Prevent duplicate labels
        if (!foundLabels.some(item => item.name.startsWith(label))) {
            foundLabels.push({
                name: `${label}.png`,
                dataUrl: generatePlaceholderDataUrl(label)
            });
        }
    }

    if (foundLabels.length === 0) {
        console.warn("No artifact patterns found in the PDF text.");
    }
    
    return foundLabels;
}

module.exports = {
    extractImagesWithLabels
};
