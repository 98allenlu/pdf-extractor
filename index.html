<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Image Extractor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>PDF Image & Label Extractor</h1>
        <p>Uses Adobe PDF Services API for sophisticated image extraction and renaming based on layout analysis.</p>

        <div id="input-area" class="card">
            <h2>1. Select PDF File</h2>
            <input type="file" id="pdfFile" accept=".pdf" required>
            <p id="fileNameDisplay">No file selected.</p>
            <p class="small-text">Note: Ensure you have replaced the Adobe API credentials in <code>pdf-extract-library.js</code>.</p>
            <button id="extractButton" disabled>Start Extraction & Naming</button>
        </div>

        <div id="status-area" class="card hidden">
            <h2>Status</h2>
            <p id="statusMessage">Processing started...</p>
            <progress id="progressBar" max="100" value="0"></progress>
        </div>

        <div id="results-area" class="card hidden">
            <h2>2. Extracted Files (Click to Open)</h2>
            <p id="resultCount"></p>
            <div id="imageGrid" class="image-grid">
                </div>
            <button id="clearButton" class="clear-button">Clear & Restart</button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const extractButton = document.getElementById('extractButton');
        const statusArea = document.getElementById('status-area');
        const statusMessage = document.getElementById('statusMessage');
        const progressBar = document.getElementById('progressBar');
        const resultsArea = document.getElementById('results-area');
        const imageGrid = document.getElementById('imageGrid');
        const resultCount = document.getElementById('resultCount');
        const clearButton = document.getElementById('clearButton');

        let currentFilePath = null;
        let currentTempDir = null;

        // --- 1. User selects file ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                currentFilePath = file.path;
                fileNameDisplay.textContent = `File Selected: ${file.name}`;
                extractButton.disabled = false;
            } else {
                currentFilePath = null;
                fileNameDisplay.textContent = 'No file selected.';
                extractButton.disabled = true;
            }
        });

        // --- 2. Start Extraction ---
        extractButton.addEventListener('click', async () => {
            if (!currentFilePath) return;

            statusArea.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            imageGrid.innerHTML = '';
            extractButton.disabled = true;
            fileInput.disabled = true;

            try {
                statusMessage.textContent = 'Uploading to Adobe and starting extraction... (This may take a minute)';
                progressBar.value = 50;

                // Call the main process extraction logic
                const result = await window.electronAPI.startProcessing(currentFilePath);
                
                progressBar.value = 100;
                statusMessage.textContent = `Success! Extracted ${result.imagesWithLabels.length} files.`;

                resultCount.textContent = `Total Files Extracted: ${result.imagesWithLabels.length}`;
                currentTempDir = result.tempDirectory;
                
                displayResults(result.imagesWithLabels);
                resultsArea.classList.remove('hidden');

            } catch (error) {
                console.error("Extraction Error:", error);
                statusMessage.textContent = `CRITICAL ERROR: ${error.message}`;
                progressBar.value = 0;
            } finally {
                extractButton.disabled = true; 
                fileInput.disabled = false;
            }
        });

        // --- 3. Display Results and Handle Clicks ---
        function displayResults(images) {
            images.forEach(imageInfo => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'image-item';
                itemDiv.title = `Click to open: ${imageInfo.name}`;
                
                // Canvas to display the image preview
                const canvas = document.createElement('canvas');
                canvas.className = 'image-canvas';
                canvas.width = 150;
                canvas.height = 150;
                
                const labelP = document.createElement('p');
                labelP.className = 'image-label';
                labelP.textContent = imageInfo.name;

                itemDiv.appendChild(canvas);
                itemDiv.appendChild(labelP);
                imageGrid.appendChild(itemDiv);
                
                // Draw Base64 image data onto the Canvas
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = function() {
                    // Scale image to fit the 150x150 canvas perfectly
                    const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width / 2) - (img.width / 2) * scale;
                    const y = (canvas.height / 2) - (img.height / 2) * scale;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                };
                img.src = imageInfo.dataUrl;
                
                // Add click listener to open the original renamed file using the Electron shell
                itemDiv.addEventListener('click', () => {
                    window.electronAPI.openFile(imageInfo.filePath);
                });
            });
        }

        // --- 4. Clear and Reset ---
        clearButton.addEventListener('click', () => {
            // Clean up the temporary folder first
            window.electronAPI.clearTemp(currentTempDir);
            currentFilePath = null;
            currentTempDir = null;
            
            // Reset UI State
            fileInput.value = '';
            fileNameDisplay.textContent = 'No file selected.';
            extractButton.disabled = true;
            statusArea.classList.add('hidden');
            resultsArea.classList.add('hidden');
            imageGrid.innerHTML = '';
        });
        
    </script>
</body>
</html>