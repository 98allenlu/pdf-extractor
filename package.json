{
  "name": "pdf-image-renamer-electron",
  "version": "1.0.0",
  "description": "A desktop app to extract artifact accession numbers from PDFs and save labeled placeholder images using pdf-poppler.",
  "main": "main.js",
  "scripts": {
    "start": "electron .",
    "test:extraction": "echo \"Running extraction tests...\""
  },
  "keywords": [
    "Electron",
    "PDF",
    "Extraction",
    "Automation"
  ],
  "author": "Generated by Gemini",
  "license": "ISC",
  "dependencies": {
    "pdf-parse": "^1.1.1",
    "pdf-poppler": "^0.3.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "electron": "^31.0.0"
  }
}
```eof

## 2. `main.js` (The Corrected Backend)

This file handles the Electron window, the user-facing dialogs, and manages the temporary file cleanup required by `pdf-poppler`.

```javascript:Electron Main Process:main.js
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const fs = require('fs');
const pdfExtractor = require('./pdf-extract-library'); 

// --- Main Application Window Logic ---

function createWindow() {
    const mainWindow = new BrowserWindow({
        width: 1000,
        height: 800,
        icon: path.join(__dirname, 'icon.png'),
        webPreferences: {
            preload: path.join(__dirname, 'preload.js'),
            nodeIntegration: false,
            contextIsolation: true
        }
    });

    mainWindow.loadFile('index.html');
}

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
    if (process.platform !== 'darwin') {
        app.quit();
    }
});

app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
        createWindow();
    }
});


// --- IPC Handlers (Communication between UI and Native) ---

/**
 * Handles the native file dialog to select the folder where all images will be saved.
 */
ipcMain.handle('select-save-directory', async () => {
    const { canceled, filePaths } = await dialog.showOpenDialog({
        properties: ['openDirectory', 'createDirectory'],
        title: 'Select Folder to Save All Images'
    });

    return canceled ? null : filePaths[0];
});

/**
 * STEP 1: Process the file (extract labels and images) and automatically save results.
 */
ipcMain.handle('start-processing', async (event, { filePath, savePath }) => {
    event.sender.send('update-status', 'Starting PDF content analysis and image extraction...');
    
    let tempDir = null;

    try {
        // 1. DUAL EXTRACTION: Extracts labels and creates temporary image files
        const extractionResponse = await pdfExtractor.extractImagesAndLabels(filePath);
        const { imagesWithLabels, tempDirectory } = extractionResponse;
        tempDir = tempDirectory; // Store temp dir for cleanup
        
        event.sender.send('update-status', `Found ${imagesWithLabels.length} artifacts. Starting automated save...`);

        // 2. Automatically trigger the saving process, reading the real image data
        const saveResponse = await handleAutoSave(event, imagesWithLabels, savePath);
        
        // 3. Cleanup happens in the finally block
        
        return {
            results: imagesWithLabels,
            saveStatus: saveResponse
        };

    } catch (error) {
        console.error("Critical Error during PDF processing:", error);
        event.sender.send('update-status', `CRITICAL ERROR: Failed to extract images. Ensure Poppler is installed/accessible. Error: ${error.message}`);
        throw new Error(`Failed to process PDF: ${error.message}`);
    } finally {
        // 4. Cleanup temporary files created by pdf-poppler
        if (tempDir && fs.existsSync(tempDir)) {
            try {
                fs.rmSync(tempDir, { recursive: true, force: true });
                console.log(`Cleaned up temporary directory: ${tempDir}`);
            } catch (e) {
                console.error(`Failed to clean up temporary directory ${tempDir}:`, e);
            }
        }
    }
});

/**
 * STEP 2: Core file saving function (triggered automatically).
 */
async function handleAutoSave(event, extractionResults, savePath) {
    let filesSaved = 0;
    let errors = [];

    // Ensure the directory exists
    try {
        if (!fs.existsSync(savePath)) {
            fs.mkdirSync(savePath, { recursive: true });
        }
    } catch (e) {
        return { success: false, message: `Failed to create directory: ${e.message}` };
    }


    for (const item of extractionResults) {
        try {
            // Data is the Base64 representation of the actual PNG/JPEG image
            const base64Data = item.dataUrl.split(';base64,').pop();
            
            // Clean filename and ensure extension is PNG
            const baseName = item.name.replace(/\.jpg|\.jpeg|\.png|\.gif$/i, ''); 
            const cleanedFileName = `${baseName.replace(/[^a-zA-Z0-9\s\.\-]/g, '').trim()}.png`;
            const filePath = path.join(savePath, cleanedFileName);
            
            // Write Buffer to disk
            fs.writeFileSync(filePath, Buffer.from(base64Data, 'base64'));
            filesSaved++;
        } catch (err) {
            console.error(`Error saving ${item.name}:`, err);
            errors.push(item.name);
            event.sender.send('update-status', `Error saving ${item.name}`);
        }
    }
    
    if (errors.length > 0) {
        const errorMessage = `Saved ${filesSaved} files to ${savePath}. Failed to save: ${errors.length} file(s).`;
        event.sender.send('update-status', errorMessage);
        return { success: false, message: errorMessage };
    } else {
        const successMessage = `Successfully saved ${filesSaved} images to ${savePath}.`;
        event.sender.send('update-status', successMessage);
        return { success: true, message: successMessage };
    }
}

/**
 * Opens the native file selection dialog for the PDF source.
 */
ipcMain.handle('open-file-dialog', async (event) => {
    const { canceled, filePaths } = await dialog.showOpenDialog({
        properties: ['openFile'],
        filters: [
            { name: 'PDF Documents', extensions: ['pdf'] }
        ]
    });
    return canceled ? null : filePaths[0];
});

// The remaining IPC handlers (download-single and select-save-directory) are unchanged.
```eof

## 3. `pdf-extract-library.js` (The Dual-Engine Logic)

This file contains the complex logic to use two different libraries for two purposes: `pdf-parse` for labeling and `pdf-poppler` for image extraction.

```javascript:PDF Extraction Library (Dual-Engine):pdf-extract-library.js
const fs = require('fs');
const path = require('path');
const os = require('os');
const pdf = require('pdf-parse'); // For text extraction and labeling
const { Poppler } = require('pdf-poppler'); // For image extraction
const _ = require('lodash'); // For array manipulation

// --- Configuration for Pattern Matching ---
// Regex to find artifact IDs like "YYYY.NN.MM [Description]".
const ARTIFACT_ID_REGEX = /(\d{4}\.\d{1,3}\.\d{1,3}[a-z]?[-\w]*(?:\s[\w\s,]+)?)/g;

/**
 * Extracts artifact labels using pdf-parse and physical images using pdf-poppler.
 * * @param {string} pdfFilePath Path to the PDF file.
 * @returns {Promise<{imagesWithLabels: Array<{name: string, dataUrl: string}>, tempDirectory: string}>} 
 */
async function extractImagesAndLabels(pdfFilePath) {
    if (!fs.existsSync(pdfFilePath)) {
        throw new Error(`File not found: ${pdfFilePath}.`);
    }

    const tempDir = path.join(os.tmpdir(), `pdf-extract-${Date.now()}`);
    fs.mkdirSync(tempDir);

    // --- STEP 1: Extract Labels (Text) ---
    const dataBuffer = fs.readFileSync(pdfFilePath);
    const data = await pdf(dataBuffer);
    const pdfText = data.text;
    
    let foundLabels = [];
    let match;

    // Use Regex to find all artifact labels in the PDF text
    while ((match = ARTIFACT_ID_REGEX.exec(pdfText)) !== null) {
        const label = match[0].trim();
        if (!foundLabels.includes(label)) {
            foundLabels.push(label);
        }
    }

    // --- STEP 2: Extract Images (Physical Files) ---
    const poppler = new Poppler();
    const options = {
        firstPage: 1,
        lastPage: data.numpages, // Process all pages
        png: true, // Extract as PNG for quality
        singleFile: false, // Ensure we get individual image files
        out_prefix: 'img_'
    };

    // pdf-poppler creates a set of images (e.g., img_1-0.png, img_1-1.png, img_2-0.png) 
    // in the temporary directory.
    await poppler.pdfToCairo(pdfFilePath, tempDir, options);

    // --- STEP 3: Match Labels to Images ---
    
    // Get all extracted image files
    const extractedFiles = fs.readdirSync(tempDir)
        .filter(file => file.endsWith('.png'))
        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

    let results = [];

    // Poppler extracts images sequentially (page 1, image 1; page 1, image 2; etc.)
    // We assume the labels are in the same sequential order as the images on the page.
    const numberOfItemsToProcess = Math.min(foundLabels.length, extractedFiles.length);

    for (let i = 0; i < numberOfItemsToProcess; i++) {
        const label = foundLabels[i];
        const tempFileName = extractedFiles[i];
        const tempFilePath = path.join(tempDir, tempFileName);

        // Convert the temporary image file to Base64 data URL for display and saving
        const imageBuffer = fs.readFileSync(tempFilePath);
        const base64Data = imageBuffer.toString('base64');

        results.push({
            name: `${label}.png`,
            dataUrl: `data:image/png;base64,${base64Data}`
        });
    }

    if (results.length === 0 && foundLabels.length > 0) {
        throw new Error("Labeling succeeded, but no images were extracted. Check Poppler installation or PDF content.");
    }
    
    console.log(`[Dual-Engine] Final matched results: ${results.length}`);
    return { 
        imagesWithLabels: results, 
        tempDirectory: tempDir 
    };
}

module.exports = {
    extractImagesAndLabels
};
```eof

## 4. `preload.js` (Security Bridge)

No change.

```javascript:Electron Preload Script:preload.js
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
    // File selection dialogs
    openFileDialog: () => ipcRenderer.invoke('open-file-dialog'),
    selectSaveDirectory: () => ipcRenderer.invoke('select-save-directory'),
    
    // Core processing function
    startProcessing: (payload) => ipcRenderer.invoke('start-processing', payload),
    
    // Single download for convenience
    downloadSingle: (item) => ipcRenderer.invoke('download-single', item),

    // Listener for status updates from the main process
    onUpdateStatus: (callback) => ipcRenderer.on('update-status', (event, message) => callback(message))
});
```eof

## 5. `index.html` (UI and Renderer Logic)

No change.

```html:PDF Image Extractor and Renamer:index.html
[Immersive content redacted for brevity.]
```eof

## 6. `styles.css` (Styles)

No change.

```css:Application Styles:styles.css
[Immersive content redacted for brevity.]
```eof

## 7. `README.md` (Instructions)

Updated to reflect the dual-engine nature.

```markdown:Setup and Run Guide:README.md
# PDF Image Labeling and Extraction Tool (Electron)

This is an Electron desktop application designed to process catalog-style PDFs, automatically extract unique accession numbers and descriptions (e.g., `YYYY.NN.MM...`), and save placeholder image data (representing the extracted photos) using these labels as the file names.

The core logic uses the **`pdf-parse`** Node.js library to read the PDF's text content and a **Regular Expression** to generalize the labeling for any PDF following the `[Four Digits].[Number].[Number] [Description]` pattern.

## Prerequisites

1.  **Node.js:** Must be installed (LTS version recommended).
2.  **Git:** To manage the repository.
3.  **VS Code:** (Recommended) for development.
4.  **Poppler Utilities:** The `pdf-poppler` library relies on the command-line Poppler utilities being installed on your system. On most systems, this is handled by the Node module, but if you encounter errors, you may need to install them manually (e.g., `sudo apt-get install poppler-utils` on Linux, or via Chocolatey/Brew on Windows/Mac).

## Setup Instructions

### 1. Install Dependencies

Open your terminal or command prompt, navigate to the root of this repository, and run:

```bash
# Install Electron, pdf-parse, and pdf-poppler
npm install